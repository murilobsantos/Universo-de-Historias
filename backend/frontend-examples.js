// ==========================================
// EXEMPLOS DE USO DA API NO FRONTEND
// ==========================================

// Configura√ß√£o base
const API_BASE_URL = 'http://localhost:3000/api';

// ==========================================
// 1. REGISTRO DE USU√ÅRIO
// ==========================================
async function registerUser(userData) {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userData)
    });

    const data = await response.json();

    if (data.success) {
      // Salvar token no localStorage
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      console.log('‚úÖ Usu√°rio registrado com sucesso!');
      return data;
    } else {
      console.error('‚ùå Erro no registro:', data.message);
      throw new Error(data.message);
    }
  } catch (error) {
    console.error('‚ùå Erro de rede:', error);
    throw error;
  }
}

// Exemplo de uso:
// registerUser({
//   name: 'Jo√£o Silva',
//   email: 'joao@email.com',
//   password: 'senha123'
// });

// ==========================================
// 2. LOGIN DE USU√ÅRIO
// ==========================================
async function loginUser(credentials) {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(credentials)
    });

    const data = await response.json();

    if (data.success) {
      // Salvar token no localStorage
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      console.log('‚úÖ Login realizado com sucesso!');
      return data;
    } else {
      console.error('‚ùå Erro no login:', data.message);
      throw new Error(data.message);
    }
  } catch (error) {
    console.error('‚ùå Erro de rede:', error);
    throw error;
  }
}

// Exemplo de uso:
// loginUser({
//   email: 'joao@email.com',
//   password: 'senha123'
// });

// ==========================================
// 3. FUN√á√ÉO HELPER PARA REQUISI√á√ïES AUTENTICADAS
// ==========================================
async function authenticatedFetch(url, options = {}) {
  const token = localStorage.getItem('token');

  if (!token) {
    throw new Error('Token n√£o encontrado. Fa√ßa login primeiro.');
  }

  const defaultOptions = {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...options.headers
    }
  };

  const response = await fetch(url, { ...options, ...defaultOptions });
  const data = await response.json();

  if (!data.success) {
    throw new Error(data.message);
  }

  return data;
}

// ==========================================
// 4. BUSCAR DADOS DO USU√ÅRIO LOGADO
// ==========================================
async function getCurrentUser() {
  try {
    const data = await authenticatedFetch(`${API_BASE_URL}/users/me`);
    console.log('‚úÖ Dados do usu√°rio:', data.user);
    return data.user;
  } catch (error) {
    console.error('‚ùå Erro ao buscar usu√°rio:', error);
    throw error;
  }
}

// ==========================================
// 5. CRIAR UMA NOVA HIST√ìRIA
// ==========================================
async function createStory(storyData) {
  try {
    const data = await authenticatedFetch(`${API_BASE_URL}/stories`, {
      method: 'POST',
      body: JSON.stringify(storyData)
    });

    console.log('‚úÖ Hist√≥ria criada com sucesso!');
    return data.story;
  } catch (error) {
    console.error('‚ùå Erro ao criar hist√≥ria:', error);
    throw error;
  }
}

// Exemplo de uso:
// createStory({
//   title: 'A Jornada √âpica',
//   synopsis: 'Uma aventura incr√≠vel atrav√©s de mundos desconhecidos...',
//   content: 'Era uma vez, em um reino distante, um jovem her√≥i chamado...',
//   genres: ['Fantasia', 'Aventura'],
//   tags: ['magia', 'her√≥is', 'drag√µes'],
//   image: 'https://exemplo.com/imagem.jpg'
// });

// ==========================================
// 6. LISTAR HIST√ìRIAS P√öBLICAS
// ==========================================
async function getStories(page = 1, filters = {}) {
  try {
    const queryParams = new URLSearchParams({
      page: page.toString(),
      ...filters
    });

    const response = await fetch(`${API_BASE_URL}/stories?${queryParams}`);
    const data = await response.json();

    if (data.success) {
      console.log('‚úÖ Hist√≥rias encontradas:', data.stories.length);
      console.log('üìÑ Pagina√ß√£o:', data.pagination);
      return data;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error('‚ùå Erro ao buscar hist√≥rias:', error);
    throw error;
  }
}

// Exemplos de uso:
// getStories(1); // Primeira p√°gina
// getStories(1, { genre: 'Fantasia' }); // Filtrar por g√™nero
// getStories(1, { search: 'drag√£o' }); // Busca por texto
// getStories(1, { sort: 'popular' }); // Ordenar por popularidade

// ==========================================
// 7. BUSCAR HIST√ìRIA ESPEC√çFICA
// ==========================================
async function getStory(storyId) {
  try {
    const response = await fetch(`${API_BASE_URL}/stories/${storyId}`);
    const data = await response.json();

    if (data.success) {
      console.log('‚úÖ Hist√≥ria encontrada:', data.story.title);
      return data.story;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error('‚ùå Erro ao buscar hist√≥ria:', error);
    throw error;
  }
}

// ==========================================
// 8. LISTAR HIST√ìRIAS DO USU√ÅRIO LOGADO
// ==========================================
async function getUserStories(page = 1) {
  try {
    const data = await authenticatedFetch(`${API_BASE_URL}/stories/user/me?page=${page}`);
    console.log('‚úÖ Hist√≥rias do usu√°rio:', data.stories.length);
    return data;
  } catch (error) {
    console.error('‚ùå Erro ao buscar hist√≥rias do usu√°rio:', error);
    throw error;
  }
}

// ==========================================
// 9. ATUALIZAR HIST√ìRIA
// ==========================================
async function updateStory(storyId, updates) {
  try {
    const data = await authenticatedFetch(`${API_BASE_URL}/stories/${storyId}`, {
      method: 'PUT',
      body: JSON.stringify(updates)
    });

    console.log('‚úÖ Hist√≥ria atualizada com sucesso!');
    return data.story;
  } catch (error) {
    console.error('‚ùå Erro ao atualizar hist√≥ria:', error);
    throw error;
  }
}

// ==========================================
// 10. EXCLUIR HIST√ìRIA
// ==========================================
async function deleteStory(storyId) {
  try {
    const data = await authenticatedFetch(`${API_BASE_URL}/stories/${storyId}`, {
      method: 'DELETE'
    });

    console.log('‚úÖ Hist√≥ria exclu√≠da com sucesso!');
    return true;
  } catch (error) {
    console.error('‚ùå Erro ao excluir hist√≥ria:', error);
    throw error;
  }
}

// ==========================================
// 11. ATUALIZAR PERFIL DO USU√ÅRIO
// ==========================================
async function updateUserProfile(updates) {
  try {
    const data = await authenticatedFetch(`${API_BASE_URL}/users/me`, {
      method: 'PUT',
      body: JSON.stringify(updates)
    });

    // Atualizar dados no localStorage
    localStorage.setItem('user', JSON.stringify(data.user));

    console.log('‚úÖ Perfil atualizado com sucesso!');
    return data.user;
  } catch (error) {
    console.error('‚ùå Erro ao atualizar perfil:', error);
    throw error;
  }
}

// ==========================================
// 12. FAZER LOGOUT
// ==========================================
function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  console.log('‚úÖ Logout realizado com sucesso!');
}

// ==========================================
// 13. VERIFICAR SE USU√ÅRIO EST√Å LOGADO
// ==========================================
function isLoggedIn() {
  const token = localStorage.getItem('token');
  const user = localStorage.getItem('user');
  return !!(token && user);
}

// ==========================================
// 14. OBTEM USU√ÅRIO DO LOCALSTORAGE
// ==========================================
function getStoredUser() {
  const user = localStorage.getItem('user');
  return user ? JSON.parse(user) : null;
}

// ==========================================
// EXEMPLO COMPLETO DE USO
// ==========================================
async function exemploCompleto() {
  try {
    // 1. Registrar usu√°rio
    console.log('üîÑ Registrando usu√°rio...');
    await registerUser({
      name: 'Jo√£o Silva',
      email: 'joao@email.com',
      password: 'senha123'
    });

    // 2. Criar uma hist√≥ria
    console.log('üîÑ Criando hist√≥ria...');
    const story = await createStory({
      title: 'Minha Primeira Hist√≥ria',
      synopsis: 'Uma jornada √©pica de descoberta...',
      content: 'Era uma vez, em um mundo distante...',
      genres: ['Fantasia'],
      tags: ['aventura', 'magia']
    });

    // 3. Listar hist√≥rias p√∫blicas
    console.log('üîÑ Buscando hist√≥rias...');
    const stories = await getStories(1);

    // 4. Buscar dados do usu√°rio
    console.log('üîÑ Buscando dados do usu√°rio...');
    const user = await getCurrentUser();

    console.log('üéâ Fluxo completo executado com sucesso!');

  } catch (error) {
    console.error('‚ùå Erro no fluxo completo:', error);
  }
}

// ==========================================
// EXPORTAR FUN√á√ïES PARA USO EM OUTROS ARQUIVOS
// ==========================================
module.exports = {
  registerUser,
  loginUser,
  authenticatedFetch,
  getCurrentUser,
  createStory,
  getStories,
  getStory,
  getUserStories,
  updateStory,
  deleteStory,
  updateUserProfile,
  logout,
  isLoggedIn,
  getStoredUser,
  exemploCompleto
};

// ==========================================
// INSTRU√á√ïES PARA USO NO FRONTEND
// ==========================================
/*
1. Copie este arquivo para seu projeto frontend
2. Importe as fun√ß√µes necess√°rias
3. Use as fun√ß√µes nos seus componentes React

Exemplo em React:

import { registerUser, loginUser, getStories } from './api.js';

function LoginComponent() {
  const handleLogin = async (credentials) => {
    try {
      const result = await loginUser(credentials);
      // Redirecionar ou atualizar estado
    } catch (error) {
      // Mostrar erro
    }
  };

  // ... resto do componente
}

4. Para usar em componentes com hooks:

import { useState, useEffect } from 'react';
import { getStories, isLoggedIn } from './api.js';

function StoriesList() {
  const [stories, setStories] = useState([]);

  useEffect(() => {
    if (isLoggedIn()) {
      getStories().then(data => setStories(data.stories));
    }
  }, []);

  // ... resto do componente
}
*/
